---
title: '"Are you happy?"'
author: "FIbry Gro"
date: "1/23/2022"
output: 
  rmdformats::downcute:
    toc_depth: 3
    toc_float: 
        collapsed: True
    downcute_theme: "chaos"
    highlight: tango
  

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
```{r}
knitr::include_graphics("happiness.png")
```

Are you happy? How are other people? And were they happier in the past? Those questions are very difficult to answer due to the uncertainty of the "happiness" definition. However, The World Happiness Report generates regularly annual report regarding global happiness and life satisfaction. The score is based on the pooled results from Gallup World Poll , which is a set of the representative survey more than 160 countries. The survey itself asked: "On which step ladder do you imagine your life is?". The possible highest and lowest of level satisfaction is 10 and  0, respectively. This life satisfaction scale is called "Cantril Ladder" method. The score itself incorporates six factors, which are economic production, social support, life expectancy, freedom, absence of corruption, and generosity. The factors do not affect the total score assigned for each country, but they do describe why some countries rank higher than others. 


# Data Information

These data sets are created by ["The World Happiness Report"](https://worldhappiness.report). However, I collected the data sets in form of CSV from [the Kaggle website](https://www.kaggle.com/ajaypalsinghlo/world-happiness-report-2021). The data set contains two files. One is data from 2006 to 2020, while the other file covers data for 2021. The variables or factors in the data set includes:

- Ladder score: The indicator of life satisfaction score, which ranges from 0 to 10.
- Log GDP per capita: A representation of a country's standard of living and describes how much citizens benefit from their country's economy.
- Healthy or Life Expectancy: Average number of years of population's healthy life.
- Social Support: the national average of the binary responses (either 0 or 1) to the question if the person has someone to count on in times of trouble or not.
- Freedom: The national average of the responses to the question of whether they are happy with the freedom they have to choose what they want to do in their life.
- Generosity: the residual of regressing the national average of response to the GWP question “Have you donated money to a charity in the past month?” on GDP per capita.
- Corruption:  the national average of the survey responses to two questions in the GWP: “Is corruption widespread throughout the government or not” and “Is corruption widespread within businesses or not?” The overall perception is just the average of the two 0-or-1 responses.

Please refer to this [link](https://happiness-report.s3.amazonaws.com/2021/Appendix1WHR2021C2.pdf) for detailed information. 

# Project Expectation

This project is part of Learn by Building (LBB) section II. The project will deliver and implement some knowledge related to data visualization by using R. The goal of the project:

- Discover countries and continents with the highest and lowest life satisfaction score in 2021. 
- Discover the correlation between each factor in the life satisfaction level.
- Discover the insight of score's comparison in 2011 and 2021 (ten years score differences). 

# Libraries Preparation

Below is the list of libraries used in this project. ***Note :  In this project, I try minimizing to use `library(dplyr)` and more utilizing `base`.***

```{r}
library(dplyr)
library(ggplot2)
library(ggthemes)
library(tidyr)
library(ggridges)
library(wesanderson)
library(hrbrthemes)
library(ggchicklet)
library(GGally)
library(gridExtra)
library(plotly) 
library(glue)
```


# Importing Data

First, read both row data sets from the working directory and assign them as variables called `data1` (data from 2006 to 2020) and `data2` (2021). Then, observe the data by applying `str()`. We found that `data1` has 1949 rows and 11 columns, while `data2` has 149 rows and 20 columns. 

```{r}
# Data set covers from 2006 to 2020. 
data1 <- read.csv("world-happiness-report.csv")
glimpse(data1)

# Data set covers 2021 
data2 <- read.csv("world-happiness-report-2021.csv")
glimpse(data2)
```

# Data Preparation

The objective in this section:

1. Observe and pick the variables or columns that will be used for visualization.
2. Drop unused columns 
3. Create a new variable called year in data frame `data2`
3. Change the column name if necessary.
4. Join both data sets into a new data frame called `happy`.
5. Check the missing values and decide if we need to drop or keep it.
6. Check duplicate data.
7. Transform data type.

## Pick Variables

The list of columns that we use in this project is `Country.name`, `year`, `Life.Ladder`, `Log.GDP.per.capital`, `Social.support`, `Healthy.life.expectancy.at.birth`, `Freedom.to.make.life.choices`,`Generosity` , and `Perceptions.of.corruption`. 

## Data Preparation  

In this section, some actions need to be done :  

-  Drop several columns in `data1` and `data2`. 
- Since `data2` covers data for 2021, create the new column `year` in data frame `data2` and fill its values with 2021. 
- Found the names in both data frames not consistent and too long. To make it better and be able to merge both data frames, perhaps we can change the name. 
- Observe both data frame by applying `head()`

```{r}
# Drop columns + rename coloumns 
data1 <- data1 %>% 
  select(Country = Country.name, 
         year, Social.support, Generosity,
         Score = Life.Ladder,  
         Log.GDP = Log.GDP.per.capita, 
         Healthy= Healthy.life.expectancy.at.birth, 
         Freedom=Freedom.to.make.life.choices, 
         Corruption=Perceptions.of.corruption)  

head(data1)
```

```{r}
# Drop columns + rename coloumns  + create a new column "year" 
data2 <- data2 %>% 
  select(Country = Country.name,
         Continent= Regional.indicator,
         Score = Ladder.score ,  
         Log.GDP = Logged.GDP.per.capita, 
         Healthy= Healthy.life.expectancy, 
         Freedom=Freedom.to.make.life.choices, 
         Corruption=Perceptions.of.corruption,
         Social.support, Generosity) %>% 
  mutate(year=2021)

head(data2)
```

## Join Both Data Frames

This section contains many steps. 

- Create a new data frame called `continent`, which containing the column `Country` and `Continent` from `data2`. 
- Merge `continent` into `data1` by using `full_join`. 
- Utilize `bind_rows()` to bind `data1` and `data2`, and assign it as new data frame called `happy`. 
- Check the data frame `happy` by applying  `glimpse()`.

```{r}
# Selecting country and Continent columns in data2 and naming it continent
continent <- data2 %>% 
  select(Country, Continent) 

# Full join data1 and continent by country that creates a new `happy`
data1 <- full_join(data1, continent, by = "Country") 

# Stacking data1 and data2 and naming the newdataframe data
happy <- bind_rows(data1, data2)

# Check the data frame `happy` by using glimpse
glimpse(happy)
```

## Treatment for Missing Value. 

Now, `happy` has 1949 rows and 10 variables. Let's observe missing values for each column by using `colSums()` and `is.na()`. 

```{r}
colSums(is.na(happy))
```
Since, we'll divide the continent into several Let's check missing value in the Continent. 

```{r}
missing <- happy %>% 
  filter(is.na(Continent))

unique(missing$Country)
```
```{r}
happy <- happy %>%
  mutate(
    Continent = case_when(Country =="Angola" | Country == "Central African Republic" |
                         Country == "Congo (Kinshasa)" | Country == "Djibouti"| 
                         Country == "Somalia" | Country == "Somaliland region"|
                         Country == "South Sudan" | Country == "Sudan"
                       ~ "Sub-Saharan Africa", TRUE ~ Continent )) %>% 
  mutate(
    Continent = case_when(Country == "Belize" | Country == "Cuba" | Country == "Guyana" |
                         Country == "Suriname" | Country == "Trinidad and Tobago"
                       ~ "Latin America and Caribbean", TRUE ~ Continent )) %>% 
  mutate(
    Continent = case_when(Country == "Oman" |  Country == "Qatar" | Country == "Syria"
                       ~ "Middle East and North Africa", TRUE ~ Continent )) %>% 
  mutate(
    Continent = case_when(Country == "Bhutan"
                       ~ "South Asia", TRUE ~ Continent ))
```



Check the percentage of missing values for each column. It seems that the proportion of missing values for each column is still acceptable for us to keep the data.

```{r}
missing.values.col <- round(as.data.frame(apply(happy, 2, function(col)sum(is.na(col))*100/length(col))),2)
missing.values.col
```
## Check Duplication

Check duplicate data in row by using `duplicated`. Great no duplicates!

```{r}
happy[duplicated(happy),]
```

## Datatype Transformation

Transform `Country` , `year` and `Continent` as factor . Sneak peak with `glimpse()` for the end result of data preparation processes.

```{r}
happy <- happy %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(year=as.factor(year)) 

glimpse(happy)
```

# Data Manipulation, Wrangling and Visualization 


```{r}
# Filter the data frame with `year` is 2021 and assigned as `happy.2021`. Order by `Score` column.
happy.2021 <- happy[happy$year == 2021,]
happy.2021 <- happy.2021[order(-happy.2021$Score),]

# Create data frame of 10 the happiest countries called `happy.country.head` and the least happy countries called `happy.country.tail`. 
happy.country.head <- head(happy.2021, 10)
happy.country.tail <- tail(happy.2021, 10)
head.tail <- rbind(happy.country.head, happy.country.tail)

head.tail
```


```{r}

plot5 <- happy %>% 
  filter(year==2021) %>% 
  arrange(-Score) %>% 
  head(10) %>% 
  ggplot(aes(x=Score, y=reorder(Country, Score), text=glue("Score: {round(Score,2)}")))+
  geom_col(aes(fill=Score))+
  scale_fill_gradientn(colors=wes_palette("FantasticFox1", 10, type = "continuous"))+
  labs(title="Top Seven Countries with The Highest Score",
       y="",
       x="Score")+
  xlim(0,10)+
  theme_set(theme_minimal() + theme(text = element_text(family="Arial Narrow"))) +
      theme(plot.title = element_text(size= 17, color = 'black', face ='bold'),
            plot.subtitle = element_text(size = 8),
            plot.caption = element_text(size = 10),
            axis.title.x = element_text(size=12, color = 'black'),
            axis.title.y = element_text(size = 12, color = 'black'),
            axis.text.x = element_text(size = 12, color = 'black'),
            axis.text.y = element_text(size = 12, color = 'black'),
            legend.text = element_text(size = 11, color = 'black'),
            legend.title = element_text(size = 12, color = 'black'),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            axis.line = element_line(colour = "black"),
            legend.position = "bottom")


 ggplotly(plot5, tooltip = "text")%>% 
      layout(title = list(text = paste0('Top Seven Countries with The Highest Score',
                                        '<br>',
                                        '<sup>',
                                        '',
                                        '</sup>')))
  
 
```







Correlation between Score, Life Expentancy and GDP. 

```{r}
# Create a function to divide Continent into three parts.
convert_continent <- function(y){ 
    if( y == "Western Europe" | y == "Central and Eastern Europe" | y == "Commonwealth of Independent States"){
      y <- "Europe"
    }else 
      if(y == "Sub-Saharan Africa" | y == "Middle East and North Africa"){
      y <- "Africa" 
    }else 
      if(y == "South Asia" | y == "Southeast Asia" | y== "East Asia"){
      y <- "Asia"  
      }else 
      if(y == "Latin America and Caribbean"){
      y <- "South America"
    }else{
      y <- "North America and Australia" 
    }  
}

# Create a variable called Cat.Continent by using `sapply` and transform data type into factor. Then, check dataframe by using `str()`
happy$Cat.Continent <- sapply(X = happy$Continent, FUN = convert_continent) 
happy$Cat.Continent <- as.factor(happy$Cat.Continent)
glimpse(happy)
```

```{r}

 plot4 <- happy %>% 
      mutate(year=as.numeric(as.character(year))) %>% 
      filter(Country == "Indonesia" | Country=="South Africa" | Country=="Finland" | Country == "United Kingdom") %>% 
      ggplot(aes(x=year, y = Score, label = Score, group=1, text=glue("Score: {round(Score,2)}")))+ 
      geom_point(aes(color = Country))+
      geom_line(aes(color = Country, group=1))+
      scale_color_manual(values = wes_palette(4, name = "Darjeeling1"))+
      xlim(2005, 2021)+
      ylim(3,9)+
      
      labs(x = "Year", y = "Life Satisfaction Score",
           title = "Life Satisfaction Score Between Country",
           caption = "Source: The World Happiness Report")+
      
      theme_set(theme_minimal() + theme(text = element_text(family="Arial Narrow"))) +
      theme(plot.title = element_text(size= 20, color = 'black', face ='bold'),
            plot.subtitle = element_text(size = 8),
            plot.caption = element_text(size = 10),
            axis.title.x = element_text(size=13, color = 'black'),
            axis.title.y = element_text(size = 13, color = 'black'),
            axis.text.x = element_text(size = 12, color = 'black'),
            axis.text.y = element_text(size = 13, color = 'black'),
            legend.text = element_text(size = 11, color = 'black'),
            legend.title = element_text(size = 12, color = 'black'),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            axis.line = element_line(colour = "black"),
            legend.position = "bottom")
      
    
    ggplotly(plot4, tooltip = "text")%>% 
      layout(title = list(text = paste0('Movement of Life Satisfaction Score',
                                        '<br>',
                                        '<sup>',
                                        '',
                                        '</sup>')))
  
```




Now, create two bubble plots in one page to describe the correlation as requested by using `ggplot` and `geom_point`. Then, utilize `grid.arrange` to show both plots into one page. 

```{r, fig.width=10, fig.height=15}  

# Create ggplot by using geom_point to create bubble plot to visualize the correlation between life expentencies, score and GDP. Assign as `plot3`
    plot1 <- happy %>% 
      filter(year==2021) %>% 
      ggplot(mapping =aes(x = Healthy, size= Log.GDP, y= Score,  fill= Cat.Continent, 
                          text = glue("Country :{Country}\nLife Satisfaction Score: {round(Score,2)}\nLog GDP per capita : {round(Log.GDP,2)}\nLife Expentancy :{round(Healthy,2)}"))) +
      geom_point(alpha=0.5, shape=21, color="white") +
      scale_size(range = c(0, 12), name="") +
      scale_fill_manual(values = wes_palette(5, name = "Darjeeling1"), name = "Continent")  +
      scale_x_continuous(breaks = seq(40,80, by=10), limits = c(40,80))+
      ylim(2,9)+
      labs(x = "Life Expectancy", y = "Life Satisfaction Score",
           title = "Correlation between Life Satisfaction Score,\n Age Expectency, and GDP",
           caption = "Source: The World Happiness Report")+
  
      theme_set(theme_minimal() + theme(text = element_text(family="Arial Narrow"))) +
      theme(plot.title = element_text(size= 17, color = 'black', face ='bold'),
            plot.subtitle = element_text(size = 8),
            plot.caption = element_text(size = 10),
            axis.title.x = element_text(size=13, color = 'black'),
            axis.title.y = element_text(size = 13, color = 'black'),
            axis.text.x = element_text(size = 12, color = 'black'),
            axis.text.y = element_text(size = 13, color = 'black'),
            legend.text = element_text(size = 11, color = 'black'),
            legend.title = element_text(size = 12, color = 'black'),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            axis.line = element_line(colour = "black"),
            legend.position = "bottom"
      ) 
    
    ggplotly(plot1, tooltip = "text") %>% 
      layout(title = list(text = paste0('Correlation between Life Satisfaction Score, Age Expectancy, and GDP by Continent',
                                    '<br>',
                                    '<sup>',
                                    'The size of bubbles illustrates the size of log.GDP per capita for each country.',
                                    '</sup>')))
```

Create distibution plot of Score

```{r}


plot3 <- happy %>% 
  filter(year == 2021) %>% 
    ggplot(aes(x = Score, group = Cat.Continent, fill=Cat.Continent))+
    scale_fill_manual(values = wes_palette(5, name = "Darjeeling1"), name = "Continent") +
    geom_density(adjust=5, alpha=.7, color="white") +
    xlim(0,10)+
  
    labs(
    x = "Life Satisfaction Score", y = "", fill = "",
    title = "Distribution Plot of Life Satisfaction Score by Continent",
    caption = "Source : The World Happiness Report 2021") +
  
    theme_set(theme_minimal() + theme(text = element_text(family="Arial Narrow"))) +
      theme(plot.title = element_text(size= 17, color = 'black', face ='bold'),
            plot.subtitle = element_text(size = 8),
            plot.caption = element_text(size = 10),
            axis.title.x = element_text(size=13, color = 'black'),
            axis.title.y = element_text(size = 13, color = 'black'),
            axis.text.x = element_text(size = 12, color = 'black'),
            axis.text.y = element_text(size = 13, color = 'black'),
            legend.text = element_text(size = 11, color = 'black'),
            legend.title = element_text(size = 12, color = 'black'),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            axis.line = element_line(colour = "black"),
            legend.position = "bottom")


ggplotly(plot3, tooltip = "x") %>% 
  layout(title = list(text = paste0('Distribution Plot of Life Satisfaction Score by Continent',
                                    '<br>',
                                    '<sup>',
                                    'Life satisfaction score ranges between 0 and 10, which 10 indicates the higest life satisfaction.',
                                    '</sup>')))
```


```{r}

# Create world3 
world3<- happy %>% 
  group_by(Country) %>% 
  select(Country, Score, year)

# pivot_wider so that all NA value in year can be fill up with 0
world3<- pivot_wider(data=world3,
            names_from="year",
            values_from="Score")

world3[is.na(world3)] <- 0

# Back to pivot_longer
world3 <- pivot_longer(
data= world3,
cols=c("2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020","2021")
)

head(world3)
# Change the coloum name
colnames(world3) <- c("Country", "year", "Score")

```


# Left join with iso data frame
iso <-map_data("world") %>% 
  rename(Country = region)  

world4<-world3 %>% 
  right_join(iso, by="Country") %>% 
  group_by(Country)

plot2 <- world4 %>% 
  filter(year==2021) %>% 
  ggplot(mapping = aes(x=long, y= lat, group=group))+
  geom_polygon(aes(fill=Score), color="white", size = 0.1) +
  scale_fill_gradientn(colors= wes_palette("Darjeeling1", 20, type = "continuous"))+
    labs(title = NULL, x = NULL, y = NULL) +
    theme_bw() + 
                       theme(axis.text = element_text(size = 14),
                       axis.title = element_text(size = 14),
                       strip.text = element_text(size = 14),
                       panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(),
                       panel.background = element_blank(), 
                       axis.text.x = element_blank(),
                       axis.text.y=element_blank(),
                       axis.ticks = element_blank(),
                       legend.position = "bottom",
                       panel.border = element_blank(), 
                       strip.background = element_rect(fill = 'white', colour = 'white'))




```{r}

# Grab the CODE for each Country 
df <- read.csv('https://raw.githubusercontent.com/plotly/datasets/master/2014_world_gdp_with_codes.csv')
df <- df %>% 
  rename(Country=COUNTRY) %>% 
  mutate(Country=as.factor(Country)) %>% 
  mutate(Country =recode(Country, 
                      'Congo, Democratic Republic of the'="Congo (Kinshasa)",
                      'Congo, Republic of the'="Congo (Brazzaville)"))

# Left join between world3 and df and assign as world4
world4 <- left_join(world3,df, by="Country")%>% filter(!is.na(Score))

# light grey boundaries
l <- list(color = toRGB("white"), width = 0.9)

# specify map projection
g <- list(
  showframe = FALSE,
  showcoastlines = FALSE,
  projection = list(type = 'Mercator')
)

library(extrafont)
world4 %>% 
  filter(year==2021) %>% 
  plot_geo()%>% 
  add_trace(
    z = ~Score, 
    color = ~Score,
    colors = "Spectral",
    text = ~Country, 
    locations = ~CODE, 
    marker = list(line = l))%>% 
  layout(
    title = list(text='Global Life Satisfaction Score', y=0.9, x=0.1, face="bold"),
    geo = g) %>% 
    colorbar(title = "Score") 
  
```


